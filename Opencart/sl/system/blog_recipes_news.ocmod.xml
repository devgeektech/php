<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>Use Blog extension to setup recipes and news posts</name>
    <code>blog_recipes_news</code>
    <version>1.0</version>
    <author>weismannweb</author>
    <link>weismannweb</link>
    <!-- Admin starts -->
    <file path="admin/language/*/extension/d_blog_module/post.php">
        <operation error="skip">
            <search><![CDATA[$_['entry_user_group']]]></search>
            <add position="before"><![CDATA[
                $_['entry_serves']              = 'Serves';
                $_['entry_serving_size']        = 'Serving Size';
                $_['entry_prep_time']           = 'Prep Time';
                $_['entry_cook_time']           = 'Cook Time';
                $_['entry_total_time']          = 'Total Time';
                $_['entry_ingredients']         = 'Ingredients';
                $_['entry_directions']          = 'Directions';
                $_['entry_related_recipe_title1'] = 'Related Recipe Title #1';
                $_['entry_related_recipe_URL1']   = 'Related Recipe URL #1';
                $_['entry_related_recipe_title2'] = 'Related Recipe Title #2';
                $_['entry_related_recipe_URL2']   = 'Related Recipe URL #2';
                $_['entry_recipes']              = 'Recipes Posts';
                $_['entry_news']                 = 'News Posts';
                $_['entry_feature']              = 'Feature';
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/d_blog_module/post.php">
        <operation error="skip">
            <search><![CDATA[$data['add']]]></search>
            <add position="before"><![CDATA[
                if (isset($this->request->get['type'])) {
                    $url .= '&type=' . $this->request->get['type'];
                }
                $data['type'] = 0;
                if (isset($this->request->get['type'])) { // 0 = default,1 = recipes,2 = news
                    if($this->request->get['type'] == 'recipes'){
                        $data['type'] = 1;
                        $this->document->setTitle($this->language->get('entry_recipes'));
                        $data['heading_title'] = $this->language->get('entry_recipes');
                        $data['text_list'] = $this->language->get('entry_recipes');
                    } elseif($this->request->get['type'] == 'news'){
                        $data['type'] = 2;
                        $this->document->setTitle($this->language->get('entry_news'));
                        $data['heading_title'] = $this->language->get('entry_news');
                        $data['text_list'] = $this->language->get('entry_news');
                    } else {
                        if($this->request->get['type'] != 'news' || $this->request->get['type'] != 'recipes') {
                            $this->response->redirect($this->model_extension_d_opencart_patch_url->link('extension/d_blog_module/post'));
                        }
                    }
                }
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[=> $order,]]></search>
            <add position="after"><![CDATA[
                'type'                  => $data['type'],
            ]]></add>
        </operation>

        <operation error="skip">
            <search><![CDATA[$data['button_filter']]]></search>
            <add position="before"><![CDATA[
                if($data['type'] == 1){ // 0 = default,1 = recipes,2 = news
                    $this->document->setTitle($this->language->get('entry_recipes'));
                    $data['heading_title'] = $this->language->get('entry_recipes');
                    $data['text_list'] = $this->language->get('entry_recipes');
                } elseif($data['type'] == 2){
                    $this->document->setTitle($this->language->get('entry_news'));
                    $data['heading_title'] = $this->language->get('entry_news');
                    $data['text_list'] = $this->language->get('entry_news');
                } else {
                    //default blog
                }
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[$data['sort_title']]]></search>
            <add position="before"><![CDATA[
                if (isset($this->request->get['type'])) {
                    $url .= '&type=' . $this->request->get['type'];
                }
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[$pagination = new Pagination();]]></search>
            <add position="before"><![CDATA[
                if (isset($this->request->get['type'])) {
                    $url .= '&type=' . $this->request->get['type'];
                }
            ]]></add>
        </operation>

        <operation error="skip">
            <search><![CDATA[if (isset($this->request->post['post_description']))]]></search>
            <add position="before"><![CDATA[
                $data['type'] = 0;
                if (isset($this->request->get['type'])) { // 0 = default,1 = recipes,2 = news
                    if($this->request->get['type'] == 'recipes'){
                        $data['type'] = 1;
                        $data['entry_description'] = $this->language->get('entry_ingredients');
                        $data['entry_short_description'] = $this->language->get('entry_directions');

                        if (isset($this->request->post['serves'])) {
                            $data['serves'] = $this->request->post['date_published'];
                        } elseif (!empty($post_info)) {
                            $data['serves'] = $post_info['serves'];
                        } else {
                            $data['serves'] = '';
                        }

                        if (isset($this->request->post['serving_size'])) {
                            $data['serving_size'] = $this->request->post['serving_size'];
                        } elseif (!empty($post_info)) {
                            $data['serving_size'] = $post_info['serving_size'];
                        } else {
                            $data['serving_size'] = '';
                        }

                        if (isset($this->request->post['prep_time'])) {
                            $data['prep_time'] = $this->request->post['prep_time'];
                        } elseif (!empty($post_info)) {
                            $data['prep_time'] = $post_info['prep_time'];
                        } else {
                            $data['prep_time'] = '';
                        }

                        if (isset($this->request->post['cook_time'])) {
                            $data['cook_time'] = $this->request->post['cook_time'];
                        } elseif (!empty($post_info)) {
                            $data['cook_time'] = $post_info['cook_time'];
                        } else {
                            $data['cook_time'] = '';
                        }

                        if (isset($this->request->post['total_time'])) {
                            $data['total_time'] = $this->request->post['total_time'];
                        } elseif (!empty($post_info)) {
                            $data['total_time'] = $post_info['total_time'];
                        } else {
                            $data['total_time'] = '';
                        }

                        if (isset($this->request->post['related_recipe_title1'])) {
                            $data['related_recipe_title1'] = $this->request->post['related_recipe_title1'];
                        } elseif (!empty($post_info)) {
                            $data['related_recipe_title1'] = $post_info['related_recipe_title1'];
                        } else {
                            $data['related_recipe_title1'] = '';
                        }

                        if (isset($this->request->post['related_recipe_URL1'])) {
                            $data['related_recipe_URL1'] = $this->request->post['related_recipe_URL1'];
                        } elseif (!empty($post_info)) {
                            $data['related_recipe_URL1'] = $post_info['related_recipe_URL1'];
                        } else {
                            $data['related_recipe_URL1'] = '';
                        }

                        if (isset($this->request->post['related_recipe_title2'])) {
                            $data['related_recipe_title2'] = $this->request->post['related_recipe_title2'];
                        } elseif (!empty($post_info)) {
                            $data['related_recipe_title2'] = $post_info['related_recipe_title2'];
                        } else {
                            $data['related_recipe_title2'] = '';
                        }

                        if (isset($this->request->post['related_recipe_URL2'])) {
                            $data['related_recipe_URL2'] = $this->request->post['related_recipe_URL2'];
                        } elseif (!empty($post_info)) {
                            $data['related_recipe_URL2'] = $post_info['related_recipe_URL2'];
                        } else {
                            $data['related_recipe_URL2'] = '';
                        }

                        if (isset($this->request->post['feature'])) {
                            $data['feature'] = $this->request->post['feature'];
                        } elseif (!empty($post_info)) {
                            $data['feature'] = $post_info['feature'];
                        } else {
                            $data['feature'] = 0;
                        }

                    } elseif($this->request->get['type'] == 'news'){
                        $data['type'] = 2;

                        if (isset($this->request->post['feature'])) {
                            $data['feature'] = $this->request->post['feature'];
                        } elseif (!empty($post_info)) {
                            $data['feature'] = $post_info['feature'];
                        } else {
                            $data['feature'] = 0;
                        }

                    } else {
                        if($this->request->get['type'] != 'news' || $this->request->get['type'] != 'recipes') {
                            $this->response->redirect($this->model_extension_d_opencart_patch_url->link('extension/d_blog_module/post'));
                        }
                    }
                }
            ]]></add>
        </operation>

        <operation error="skip">
            <search><![CDATA[if (isset($this->request->get['filter_title']) || isset($this->request->get['filter_tag'])) {]]></search>
            <add position="after"><![CDATA[
                if (isset($this->request->get['type'])) { // 0 = default,1 = recipes,2 = news
                    $type = $this->request->get['type'];
                } else {
                    $type = 0;
                }
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA['filter_tag'   => $filter_tag,]]></search>
            <add position="after"><![CDATA[
                'type'         => $type,
            ]]></add>
        </operation>

        <operation error="skip">
            <search><![CDATA[$this->response->redirect($this->model_extension_d_opencart_patch_url->link('extension/d_blog_module/post'));]]></search>
            <add position="replace"><![CDATA[
                if (isset($this->request->post['type'])) { // 0 = default,1 = recipes,2 = news
                    if($this->request->post['type'] == '1'){
                        $this->response->redirect($this->model_extension_d_opencart_patch_url->link('extension/d_blog_module/post&type=recipes'));
                    } else if($this->request->post['type'] == '2'){
                        $this->response->redirect($this->model_extension_d_opencart_patch_url->link('extension/d_blog_module/post&type=news'));
                    }
                }
                if (isset($this->request->get['type'])) { // 0 = default,1 = recipes,2 = news
                    if($this->request->get['type'] == 'recipes'){
                        $this->response->redirect($this->model_extension_d_opencart_patch_url->link('extension/d_blog_module/post&type=recipes'));
                    } else if($this->request->get['type'] == 'news'){
                        $this->response->redirect($this->model_extension_d_opencart_patch_url->link('extension/d_blog_module/post&type=news'));
                    }
                }

                $this->response->redirect($this->model_extension_d_opencart_patch_url->link('extension/d_blog_module/post'));
            ]]></add>
        </operation>
    </file>

    <file path="admin/model/extension/d_blog_module/post.php">
        <operation error="skip">
            <search><![CDATA[if (isset($data['image'])) {]]></search>
            <add position="before"><![CDATA[
                if ($data['type'] == 1) { // 0 = default,1 = recipes,2 = news
                    $this->db->query("UPDATE " . DB_PREFIX . "bm_post
                        SET serves = '" . $this->db->escape($data['serves']) . "',
                            serving_size = '" . $this->db->escape($data['serving_size']) . "',
                            prep_time = '" . $this->db->escape($data['prep_time']) . "',
                            cook_time = '" . $this->db->escape($data['cook_time']) . "',
                            total_time = '" . $this->db->escape($data['total_time']) . "',
                            related_recipe_title1 = '" . $this->db->escape($data['related_recipe_title1']) . "',
                            related_recipe_URL1 = '" . $this->db->escape($data['related_recipe_URL1']) . "',
                            related_recipe_title2 = '" . $this->db->escape($data['related_recipe_title2']) . "',
                            related_recipe_URL2 = '" . $this->db->escape($data['related_recipe_URL2']) . "',
                            type = '1',
                            feature = '" . (int)$data['feature'] . "'
                        WHERE post_id = '" . (int)$post_id . "'");
                } else if ($data['type'] == 2) {
                    $this->db->query("UPDATE " . DB_PREFIX . "bm_post
                        SET type = '2', feature = '" . (int)$data['feature'] . "' WHERE post_id = '" . (int)$post_id . "'");
                } else {
                    $this->db->query("UPDATE " . DB_PREFIX . "bm_post
                        SET type = '0' WHERE post_id = '" . (int)$post_id . "'");
                }
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[if (!empty($data['filter_date_added']))]]></search>
            <add position="before"><![CDATA[
                if (isset($data['type']) && !empty($data['type'])) {
                    $sql .= " AND p.type = '" . (int)$data['type'] . "'";
                } else {
                    $sql .= " AND p.type = 0";
                }
            ]]></add>
        </operation>
    </file>

    <file path="admin/view/template/extension/d_blog_module/post_list.twig">
        <operation error="skip">
            <search><![CDATA[url: '{{post_autocomplete}}&filter_title=' + encodeURIComponent(request),]]></search>
            <add position="replace"><![CDATA[
                url: '{{post_autocomplete}}&type={{type}}&filter_title=' + encodeURIComponent(request),
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[url: '{{post_autocomplete}}&filter_tag=' + encodeURIComponent(request),]]></search>
            <add position="replace"><![CDATA[
                url: '{{post_autocomplete}}&type={{type}}&filter_tag=' + encodeURIComponent(request),
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[if (filter_status !== '*') {]]></search>
            <add position="before"><![CDATA[
                var type = {{type}};
                if (type) {
                    if(type == 1){
                        url += '&type=recipes';
                    } else if(type == 2){
                        url += '&type=news';
                    } else {
                        //skip
                    }
                }
            ]]></add>
        </operation>
    </file>

    <file path="admin/view/template/extension/d_blog_module/post_form.twig">
        <operation error="skip">
            <search><![CDATA[<label class="col-sm-2 control-label" for="input-meta-title{{language.language_id}}">{{entry_meta_title}}</label>]]></search>
            <add position="before" offset="1"><![CDATA[
                <input type="hidden" name="type" value="{{ type }}" />
                {% if type == 1 %}
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-serves">{{ entry_serves }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="serves" value="{{ serves }}" placeholder="{{ entry_serves }}" id="input-serves" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-serving_size">{{ entry_serving_size }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="serving_size" value="{{ serving_size }}" placeholder="{{ entry_serving_size }}" id="input-serving_size" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-prep_time">{{ entry_prep_time }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="prep_time" value="{{ prep_time }}" placeholder="{{ entry_prep_time }}" id="input-prep_time" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-cook_time">{{ entry_cook_time }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="cook_time" value="{{ cook_time }}" placeholder="{{ entry_cook_time }}" id="input-cook_time" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-total_time">{{ entry_total_time }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="total_time" value="{{ total_time }}" placeholder="{{ entry_total_time }}" id="input-total_time" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-related_recipe_title1">{{ entry_related_recipe_title1 }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="related_recipe_title1" value="{{ related_recipe_title1 }}" placeholder="{{ entry_related_recipe_title1 }}" id="input-related_recipe_title1" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-related_recipe_URL1">{{ entry_related_recipe_URL1 }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="related_recipe_URL1" value="{{ related_recipe_URL1 }}" placeholder="{{ entry_related_recipe_URL1 }}" id="input-related_recipe_URL1" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-related_recipe_title2">{{ entry_related_recipe_title2 }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="related_recipe_title2" value="{{ related_recipe_title2 }}" placeholder="{{ entry_related_recipe_title2 }}" id="input-related_recipe_title2" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-related_recipe_URL2">{{ entry_related_recipe_URL2 }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="related_recipe_URL2" value="{{ related_recipe_URL2 }}" placeholder="{{ entry_related_recipe_URL2 }}" id="input-related_recipe_URL2" class="form-control" />
                        </div>
                    </div>
                {% endif %}

            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[<label class="col-sm-2 control-label" for="input-images-review">{{entry_images_review}}</label>]]></search>
            <add position="before" offset="1"><![CDATA[
                {% if type == 1 or type == 2 %}
                <div class="form-group">
                    <label class="col-sm-2 control-label" for="input-review-display">{{entry_feature}}</label>
                        <div class="col-sm-10">
                            <select name="feature" id="input-feature" class="form-control">
                                        {% if feature == 1 %}
                                        <option value="1" selected="selected">{{text_yes}}</option>
                                        <option value="0">{{text_no}}</option>
                                        {% endif %}
                                        {% if feature == 0 %}
                                        <option value="1">{{text_yes}}</option>
                                        <option value="0" selected="selected">{{text_no}}</option>
                                       {% endif %}
                            </select>
                        </div>
                </div>
                {% endif %}
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[input-keyword]]></search>
            <add position="replace" trim="true"><![CDATA[date_published]]></add>
        </operation>
    </file>
    <file path="catalog/controller/extension/d_blog_module/post.php">
        <operation>
            <search><![CDATA[$data['rating'] = $rating;]]></search>
            <add position="before" trim="true"><![CDATA[if (strlen($data['description']) <= $this->setting['post_thumb']['description_length']) {
					$data['description'] = str_replace('...', '', $data['description']);
				}]]></add>
        </operation>
        <operation>
            <search><![CDATA[$post_info = $this->model_extension_d_blog_module_post->getPost($post_id);]]></search>
            <add position="replace" trim="true"><![CDATA[$PostType = '';
        $PostType = $this->model_extension_d_blog_module_post->gettypePostID($post_id);
        if(in_array(1, $PostType)){
            $data['post_type'] = 'recipes';
            $post_info = $this->model_extension_d_blog_module_post->getPostByType($post_id, 1);
            $data['serves'] = $post_info['serves'];
            $data['short_description'] = $post_info['short_description'];
            $data['serving_size'] = $post_info['serving_size'];
            $data['prep_time'] = $post_info['prep_time'];
            $data['cook_time'] = $post_info['cook_time'];
            $data['total_time'] = $post_info['total_time'];
        }else{
        $post_info = $this->model_extension_d_blog_module_post->getPost($post_id);
        }]]></add>
        </operation>

        <operation>
            <search><![CDATA[$data['thumb'] = $this->model_tool_image->resize($post_info['image'], $this->setting['post']['image_width'], $this->setting['post']['image_height']);]]></search>
            <add position="replace" trim="true"><![CDATA[
                if($PostType['type'] == 2)
                    $data['thumb'] = $this->model_tool_image->resize($post_info['image'], 770, 306);
                else
                    $data['thumb'] = $this->model_tool_image->resize($post_info['image'], $this->setting['post']['image_width'], $this->setting['post']['image_height']);
          ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$data['thumb'] = '';]]></search>
            <add position="replace" trim="true"><![CDATA[
                $data['thumb'] = $this->model_tool_image->resize('placeholder.png', $this->setting['post']['image_width'], $this->setting['post']['image_height']);
          ]]></add>
        </operation>
          <operation>
            <search><![CDATA[$parent_category = $categories[0];]]></search>
            <add position="replace"><![CDATA[
                    if(count($categories) > 1){
                        $parent_category = $categories[1];
                    } else {
                        $parent_category = $categories[0];
                    }
             ]]></add>
        </operation>
        <operation>
            <search><![CDATA[foreach ($parents as $category) {]]></search>
            <add position="before"><![CDATA[
                $url_recipe = 'extension/d_blog_module/category';
                if(isset($parents[0])){
                    if($parents[0]['title'] == 'Recipes') {
                        $url_recipe = 'extension/d_blog_module/post/type&type=recipes';
                    }
                }
             ]]></add>
        </operation>
        <operation>
            <search index="1"><![CDATA[$this->url->link('extension/d_blog_module/category', 'category_id=' . $category['category_id'] . $url, 'SSL')]]></search>
            <add position="replace" ><![CDATA[$this->url->link($url_recipe, 'category_id=' . $category['category_id'] . $url, 'SSL')]]></add>
        </operation>
        <operation>
            <search><![CDATA[$this->url->link('extension/d_blog_module/category', 'category_id=' . $parent_category['category_id'] . $url, 'SSL')]]></search>
            <add position="replace"><![CDATA[$this->url->link($url_recipe, 'category_id=' . $parent_category['category_id'] . $url, 'SSL')]]></add>
        </operation>
        <operation>
            <search><![CDATA[public function postRestrict($post_id)]]></search>
            <add position="before" trim="true"><![CDATA[
public function type(){
        $data['breadcrumbs'] = array();
        
        if (isset($this->request->get['type'])) {
            $Gettype = $this->request->get['type'];
            if($Gettype){
                $data['post_type'] = $Gettype;
            }
        }
        $main_cat_id = '';
        $data['submit_recipe'] = $this->url->link('information/information', 'information_id=10', true);
        $limit = 20;
        $page_title = 'Our Blog';
        if($Gettype == 'recipes'){
            $type = 1;
            $name = 'Recipes';
            $main_cat_id = 10;
            $page_title = 'Recipes - Stoneledge Farm - Leeds, NY';
        }else if ($Gettype == 'news'){
            $type = 2;
            $name = 'News';
            $main_cat_id = 11;
            $page_title = 'News - Stoneledge Farm - Leeds, NY';
            $limit = 6;
        }else{
            $type = 0;
            $name = 'Our Blog';
        }
        if (isset($this->request->get['tag'])) {
            $tag = $this->request->get['tag'];
        } elseif (isset($this->request->get['search'])) {
            $tag = $this->request->get['search'];
        } else {
            $tag = '';
        }
        if (isset($this->request->get['description'])) {
            $description = $this->request->get['description'];
        } else {
            $description = '';
        }
        if (isset($this->request->get['category_id'])) {
            $category_id = $this->request->get['category_id'];
            $open_cat_name = $this->model_extension_d_blog_module_category->getCategory($category_id);
            if($open_cat_name)
                $name = $open_cat_name['title'];
        } else {
            $category_id = 0;
        }
                $data['category_id'] = $category_id;
                //cateogry image
        if (!empty($open_cat_name['image'])) {
            $open_cat_name['image_width'] = (!empty($open_cat_name['image_width'])) ? $open_cat_name['image_width'] : $this->setting['category']['image_width'];
            $open_cat_name['image_height'] = (!empty($open_cat_name['image_height'])) ? $open_cat_name['image_height'] : $this->setting['category']['image_height'];
            $data['thumb'] = $this->model_tool_image->resize($open_cat_name['image'], $open_cat_name['image_width'], $open_cat_name['image_height']);
        } else {
            $data['thumb'] = '';
        }
        if (isset($this->request->get['sub_category'])) {
            $sub_category = $this->request->get['sub_category'];
        } else {
            $sub_category = '';
        }
        if (isset($this->request->get['page'])) {
            $page = $this->request->get['page'];
        } else {
            $page = 1;
        }
        if (isset($this->request->get['sort'])) {
            $sort = $this->request->get['sort'];
        } else {
            if($type == '2')
                $sort = 'p.date_published';
            else
                $sort = 'pd.title';
        }
        if (isset($this->request->get['order'])) {
            $order = $this->request->get['order'];
        } else {
            if($type == '2')
                $order = 'DESC';
            else   
                $order = 'ASC';
        }
        $url = '';
        if (isset($this->request->get['tag'])) {
            $url .= '&tag=' . urlencode(html_entity_decode($this->request->get['tag'], ENT_QUOTES, 'UTF-8'));
        }
        if (isset($this->request->get['description'])) {
            $url .= '&description=' . $this->request->get['description'];
        }
        if (isset($this->request->get['category_id'])) {
            $url .= '&category_id=' . $this->request->get['category_id'];
        }
        if (isset($this->request->get['sub_category'])) {
            $url .= '&sub_category=' . $this->request->get['sub_category'];
        }
        if (isset($this->request->get['sort'])) {
            $url .= '&sort=' . $this->request->get['sort'];
        }
        if (isset($this->request->get['order'])) {
            $url .= '&order=' . $this->request->get['order'];
        }
        if (isset($this->request->get['page'])) {
            $url .= '&page=' . $this->request->get['page'];
        }
        if (isset($this->request->get['limit'])) {
            $url .= '&limit=' . $this->request->get['limit'];
        }
        $data['heading_title'] = $name;
        $this->document->setTitle($page_title);
        if (isset($this->request->get['limit'])) {
            $limit = (int)$this->request->get['limit'];
        } else {
            $limit = $limit;
        }
        $filter = array(
        'filter_post_type' => $type,
        'filter_tag'          => $tag,
        'filter_description'  => $description,
        'filter_category_id'  => $category_id,
        'filter_sub_category' => $sub_category,
        'sort'                => $sort,
        'order'               => $order,
        'start'               => ($page - 1) * $limit,
        'limit'               => $limit
        );
        $post_total = $this->model_extension_d_blog_module_post->getTypeTotalPosts($filter);
        $pagination = new Pagination();
        $pagination->total = $post_total;
        $pagination->page = $page;
        $pagination->limit = $limit;
        $pagination->url = $this->url->link('extension/d_blog_module/post/type&type='.$Gettype, '&page={page}');
        $data['pagination'] = $pagination->render();
        $data['results'] = sprintf($this->language->get('text_pagination'), ($post_total) ? (($page - 1) * $limit) + 1 : 0, ((($page - 1) * $limit) > ($post_total - $limit)) ? $post_total : ((($page - 1) * $limit) + $limit), $post_total, ceil($post_total / $limit));
        //echo $page;
        // http://googlewebmastercentral.blogspot.com/2011/09/pagination-with-relnext-and-relprev.html
        if ($page == 1) {
          $this->document->addLink($this->url->link('extension/d_blog_module/post/type&type='.$Gettype, '', true), 'canonical');
        } else {
          $this->document->addLink($this->url->link('extension/d_blog_module/post/type&type='.$Gettype, 'page='. $page , true), 'canonical');
        }
        if ($page > 1) {
          $this->document->addLink($this->url->link('extension/d_blog_module/post/type&type='.$Gettype, (($page - 2) ? '&page='. ($page - 1) : ''), true), 'prev');
        }
        if ($limit && ceil($post_total / $limit) > $page) {
          $this->document->addLink($this->url->link('extension/d_blog_module/post/type&type='.$Gettype, 'page='. ($page + 1), true), 'next');
        }
        $data['sort'] = $sort;
        $data['order'] = $order;
        $data['limit'] = $limit;
        $posts = $this->model_extension_d_blog_module_post->gettypePosts($filter);
        $data['posts'] = array();
        foreach ($posts as $post) {
            $data['posts'][] = $this->load->controller('extension/d_blog_module/post/thumb', $post['post_id']);
        }
        foreach ($data['posts'] as $post) {
            if ($post) {
                $category_recipe_info = array();
                $post_categories = $this->model_extension_d_blog_module_category->getCategoryByPostId($post['post_id']);
                foreach ($post_categories as $category_recipe) {
                    $category_recipe_info[] = array(
                        'category_id' => $category_recipe['category_id'],
                        'title' => $category_recipe['title'],
                        'href'  => $this->url->link('extension/d_blog_module/category', 'category_id=' . $category_recipe['category_id'], 'SSL')
                    );
                }

                if (isset($category_recipe_info[0])) {
                    $parent_category = $category_recipe_info[0];
                }
                if ($parent_category) {
                    $parents = $this->model_extension_d_blog_module_category->getCategoryParents($parent_category['category_id']);
                    foreach ($parents as $category) {
                        $category_recipe_info[] = array(
                            'title' => $category['title'],
                            'href' => $this->url->link('extension/d_blog_module/category', 'category_id=' . $category['category_id'] . $url, 'SSL')
                        );
                    }
                }

                 $description = utf8_substr(strip_tags(html_entity_decode($post['description'], ENT_QUOTES, 'UTF-8')), 0, $this->setting['post_thumb']['description_length']) . '...';
                if (strlen($description) <= $this->setting['post_thumb']['description_length']) {
                    $description = str_replace('...', '', $description);
		}

                $data['post'][] = array(
                'date_published'    => $post['date_published'],
                'text'              => $post['title'],
                'categories'        => $category_recipe_info,
                'href'              => $this->url->link('extension/d_blog_module/post', 'post_id=' . $post['post_id']),
                'short_description' => utf8_substr(strip_tags(html_entity_decode($post['short_description'], ENT_QUOTES, 'UTF-8')), 0, $this->setting['post']['short_description_length']) . '...',
                'description' => $description,
                'thumb'             => $post['thumb'],
            );
            }
        }
                
                
        if($category_id) {
            $parents = $this->model_extension_d_blog_module_category->getCategoryParents($category_id);
            foreach ($parents as $parent) {
                $data['breadcrumbs'][] = array(
                    'text' => $parent['title'],
                    'href' => $this->url->link('extension/d_blog_module/category', 'category_id=' . $parent['category_id'], 'SSL')
                );
            }
            $data['breadcrumbs'][] = array('text' => $open_cat_name['title']);                
        }        
                
                
        //categories
        $data['categories'] = array();
        $categories = $this->model_extension_d_blog_module_category->getCategories($category_id);

	$main_categories = $this->model_extension_d_blog_module_category->getCategoryParents($category_id);
        $current_category_parents_count =  count($main_categories);
	$data['second_level_title'] = '';
        $data['second_level_id'] = '';
        $main_cat_index = 0;
	foreach($main_categories as $m_Cat){
            if($main_cat_index == 1) {
               $data['second_level_title'] = $m_Cat['title'];
               $data['second_level_id'] = $m_Cat['category_id'];
            }
           $main_cat_index++;
        }

        $this->load->model('tool/image');

            $sub_Cats = $this->model_extension_d_blog_module_category->getCategories($main_cat_id);//fetch 2nd level recipe categoreis
            $data['sub_Cat'] = array();
            if ($sub_Cats) {
                foreach ($sub_Cats as $sub_Cat) {

                    if( $data['second_level_id'] == $sub_Cat['category_id']) {//show 2nd level image on 3rd level category
			$data['second_level_img'] = $this->model_tool_image->resize($sub_Cat['image'], 50, 50);
                    }

                    $data['sub_Cat'][] = array(
                        'category_id' => $sub_Cat['category_id'],
                        'image' => $this->model_tool_image->resize($sub_Cat['image'], 50, 50),
                        'title' => $sub_Cat['title'],
                        'href'  => $this->url->link('extension/d_blog_module/post/type&type=recipes', 'category_id=' . $sub_Cat['category_id'], 'SSL')
                    );
                }
            }

         //on recepie 3rd level categories we always have to show siblings
        if($data['second_level_id']) {
            $categories = $this->model_extension_d_blog_module_category->getCategories($data['second_level_id']);
        }

        //Latest
      $this->load->model('catalog/product');
      $data['latestproducts'] = array();
      $results = $this->model_catalog_product->getLatestProducts(8);
      foreach ($results as $result) {
          if ($result['image']) {
              $image = $this->model_tool_image->resize($result['image'], $this->config->get('theme_' . $this->config->get('config_theme') . '_image_product_width'), $this->config->get('theme_' . $this->config->get('config_theme') . '_image_product_height'));
          } else {
              $image = $this->model_tool_image->resize('placeholder.png', $this->config->get('theme_' . $this->config->get('config_theme') . '_image_product_width'), $this->config->get('theme_' . $this->config->get('config_theme') . '_image_product_height'));
          }
          if ($this->customer->isLogged() || !$this->config->get('config_customer_price')) {
              $price = $this->currency->format($this->tax->calculate($result['price'], $result['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);
          } else {
              $price = false;
          }
          if ((float)$result['special']) {
              $special = $this->currency->format($this->tax->calculate($result['special'], $result['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);
          } else {
              $special = false;
          }
          if ($this->config->get('config_tax')) {
              $tax = $this->currency->format((float)$result['special'] ? $result['special'] : $result['price'], $this->session->data['currency']);
          } else {
              $tax = false;
          }
          if ($this->config->get('config_review_status')) {
              $rating = (int)$result['rating'];
          } else {
              $rating = false;
          }
          $data['latestproducts'][] = array(
              'product_id'  => $result['product_id'],
              'thumb'       => $image,
              'name'        => $result['name'],
              'description' => utf8_substr(trim(strip_tags(html_entity_decode($result['description'], ENT_QUOTES, 'UTF-8'))), 0, $this->config->get('theme_' . $this->config->get('config_theme') . '_product_description_length')) . '..',
              'price'       => $price,
              'special'     => $special,
              'tax'         => $tax,
              'minimum'     => $result['minimum'] > 0 ? $result['minimum'] : 1,
              'rating'      => $result['rating'],
              'href'        => $this->url->link('product/product', '&product_id=' . $result['product_id'])
          );
      }
      //Recipe and News
      $this->load->model('extension/d_blog_module/post');
      $this->load->model('extension/d_blog_module/category');
      $data['recipe_post'] = array();
      $data['recipe_posts'] = array();
      $data['recipes_link'] = $this->url->link('extension/d_blog_module/post/type&type=recipes');
      $data['news_link'] = $this->url->link('extension/d_blog_module/post/type&type=news');
      $recipe_filter = array('filter_post_type' => '1');
      /*$recipe_posts = $this->model_extension_d_blog_module_post->gettypePosts($recipe_filter);
      foreach ($recipe_posts as $recipe_post) {
          $data['recipe_posts'][] = $this->load->controller('extension/d_blog_module/post/thumb', $recipe_post['post_id']);
      }
      foreach ($data['recipe_posts'] as $recipe_loop) {
          if ($recipe_loop) {
              $category_recipe_info = array();
              $post_categories = $this->model_extension_d_blog_module_category->getCategoryByPostId($recipe_loop['post_id']);
              foreach ($post_categories as $category_recipe) {
                  $category_recipe_info[] = array(
                      'title' => $category_recipe['title'],
                      'href'  => $this->url->link('extension/d_blog_module/category', 'category_id=' . $category_recipe['category_id'], 'SSL')
                  );
              }
              //print_r($recipe_loop);
              $data['recipe_post'][] = array(
              'text'              => $recipe_loop['title'],
              'categories'        => $category_recipe_info,
              'href'              => $this->url->link('extension/d_blog_module/post', 'post_id=' . $recipe_loop['post_id']),
              'short_description' => utf8_substr(strip_tags(html_entity_decode($recipe_loop['short_description'], ENT_QUOTES, 'UTF-8')), 0, $this->setting['post']['short_description_length']) . '...',
              'thumb'             => $recipe_loop['thumb'],
          );
          }
      }*/
      $news_filter = array('filter_post_type' => '2');
          $news_posts = $this->model_extension_d_blog_module_post->gettypePosts($news_filter);
          foreach ($news_posts as $news_post) {
              $data['news_posts'][] = $this->load->controller('extension/d_blog_module/post/thumb', $news_post['post_id']);
          }
          foreach ($data['news_posts'] as $news_loop) {
              if ($news_loop) {
                  //print_r($recipe_loop);
                  $data['news_post'][] = array(
                  'text'              => $news_loop['title'],
                  'href'              => $this->url->link('extension/d_blog_module/post', 'post_id=' . $news_loop['post_id']),
                  'short_description' => utf8_substr(strip_tags(html_entity_decode($news_loop['short_description'], ENT_QUOTES, 'UTF-8')), 0, $this->setting['post']['short_description_length']) . '...',
                  'thumb'             => $news_loop['thumb'],
              );
              }
          }
        $data['column_left'] = $this->load->controller('common/column_left');
        $data['column_right'] = $this->load->controller('common/column_right');
        $data['content_top'] = $this->load->controller('common/content_top');
        $data['content_bottom'] = $this->load->controller('common/content_bottom');
        $data['footer'] = $this->load->controller('common/footer');
        $data['header'] = $this->load->controller('common/header');
                if($Gettype == 'news') {//news
                    $news_categories = $this->model_extension_d_blog_module_category->getCategories(11);//show category dropdown on top
                    foreach($news_categories as $news_category) {
                        $data['news_categories'][] = array(
                            'category_id' => $news_category['category_id'],
                            'title' => $news_category['title'],
                            'href' => $this->url->link('extension/d_blog_module/category', 'category_id=' . $news_category['category_id'], 'SSL')
                        );
                    }
                    $data['all_new_link'] = $this->url->link('extension/d_blog_module/post/type&type=news', '', 'SSL');
                    $this->response->setOutput($this->load->view('extension/d_blog_module/post_type_news', $data));
                } elseif($Gettype == 'recipes') {//recepie
                    foreach ($categories as $category) {
                        $filter_data = array('filter_category_id' => $category['category_id'], 'filter_sub_category' => true);

                        if ($category['image']) {
                            $thumb = $this->model_tool_image->resize($category['image'], $this->setting['category']['sub_category_image_width'], $this->setting['category']['sub_category_image_height']);
                        } else {
                            $thumb = $this->model_tool_image->resize('placeholder.png', $this->setting['category']['sub_category_image_width'], $this->setting['category']['sub_category_image_height']);
                        }
                        
                        if (isset($this->request->get['type']) && $this->request->get['type'] == 'recipes' ) {
                            $cat_href = $this->url->link('extension/d_blog_module/post/type&type=recipes', 'category_id=' . $category['category_id'], 'SSL');
                        } else {
                            $cat_href = $this->url->link('extension/d_blog_module/category', 'category_id=' . $category['category_id'], 'SSL');
                        }
                
                        $data['categories'][] = array(
                            'thumb' => $thumb,
                            'category_id' => $category['category_id'],
                            'title' => $category['title'] . ($this->setting['category']['sub_category_post_count'] ? ' (' . $this->model_extension_d_blog_module_post->getTotalPostsByCategoryId($category['category_id']) . ')' : ''),
                            'href'  => $cat_href,
                            'col'   => ($this->setting['category']['sub_category_col']) ? round(12 / $this->setting['category']['sub_category_col']) : 12
                        );
                    }

                    $this->response->setOutput($this->load->view('extension/d_blog_module/post_type', $data));
                } else {
                    $this->response->setOutput($this->load->view('extension/d_blog_module/post_type', $data));
                }

    }
          ]]></add>
        </operation>

        <operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->model_extension_d_opencart_patch_load->view('extension/d_blog_module/post', $data));]]></search>
            <add position="delete"><![CDATA[
                //logic to load post detail page:- change template layout based on post type or post parent category

                if($PostType['type'] == 2) {//news
                    $this->response->setOutput($this->model_extension_d_opencart_patch_load->view('extension/d_blog_module/post_news', $data));
                } elseif($PostType['type'] == 1) {//recepie
                    $this->response->setOutput($this->model_extension_d_opencart_patch_load->view('extension/d_blog_module/post', $data));
                } else {
                    $this->response->setOutput($this->model_extension_d_opencart_patch_load->view('extension/d_blog_module/post', $data));
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[foreach ($post_categories as $category) {]]></search>
            <add position="after" offset="2"><![CDATA[
                        'category_id' => $category['category_id'],
             ]]></add>
        </operation>
      
        <operation>
            <search><![CDATA[$rating = (isset($post['rating'])) ? $post['rating'] : FALSE;]]></search>
            <add position="before"><![CDATA[
            if (isset($category_info[0])) {
                    $parent_category = $category_info[0];  
            }
            if ($parent_category) {
                $parents = $this->model_extension_d_blog_module_category->getCategoryParents($parent_category['category_id']);
                foreach ($parents as $category) {
                    $category_info[] = array(
                        'title' => $category['title'],
                        'href' => $this->url->link('extension/d_blog_module/category', 'category_id=' . $category['category_id'] . $url, 'SSL')
                    );
                }
            }

            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[$image = $this->model_tool_image->resize($post['image'], $this->setting['post_thumb']['image_width'], $this->setting['post_thumb']['image_height']);]]></search>
            <add position="delete"><![CDATA[
               if ($post['type'] == '1') {//type recipe
                $image = $this->model_tool_image->resize($post['image'], 261, 261);
               } else {
                $image = $this->model_tool_image->resize($post['image'], $this->setting['post_thumb']['image_width'], $this->setting['post_thumb']['image_height']);
               } 
            ]]></add>
        </operation>
    </file>

    <file path="catalog/model/extension/d_blog_module/post.php">
        <operation error="skip">
            <search><![CDATA[public function getPosts($data = array())]]></search>
            <add position="before"><![CDATA[
                public function gettypePosts($data = array())
                {
                    $sql = "SELECT p.post_id ";
                    if (!empty($data['filter_category_id'])) {
                        $sql .= " FROM " . DB_PREFIX . "bm_post_to_category p2c";
                        $sql .= " LEFT JOIN " . DB_PREFIX . "bm_post p ON (p2c.post_id = p.post_id)";
                    } else {
                        $sql .= " FROM " . DB_PREFIX . "bm_post p ";
                    }
                    $sql .= " LEFT JOIN " . DB_PREFIX . "bm_post_description pd ON (p.post_id = pd.post_id) "
                        . "LEFT JOIN " . DB_PREFIX . "bm_post_to_store p2s ON (p.post_id = p2s.post_id) "
                        . "Left JOIN " . DB_PREFIX . "bm_review r ON (p.post_id = r.post_id) "
                        . "WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "' "
                        . "AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' "
                        . "AND p.date_published < NOW()"
                        . "AND p.type = '" . (int)$data['filter_post_type'] . "'"
                        . "AND p.status = '1' ";
                    if (!empty($data['filter_name']) && !empty($data['filter_description'])) {
                        $sql .= " AND ( pd.title LIKE '%" . $data['filter_name'] . "%' OR pd.description LIKE '%" . $data['filter_description'] . "%' )";
                    } else {
                        if (!empty($data['filter_name'])) {
                            $sql .= " AND pd.title LIKE '%" . $data['filter_name'] . "%'";
                        }
                        if (!empty($data['filter_description'])) {
                            $sql .= " AND pd.description LIKE '%" . $data['filter_description'] . "%'";
                        }
                    }
                    if (!empty($data['filter_tag'])) {
                        $sql .= " AND pd.tag LIKE '%" . $data['filter_tag'] . "%'";
                    }
                    if (!empty($data['filter_date_published'])) {
                        $date = preg_split("/-/", $data['filter_date_published']);
                        $sql .= "AND YEAR(p.date_published) = " . $date[1] . " AND MONTH(p.date_published) = " . $date[0];
                    }
                    if (!empty($data['filter_author_id'])) {
                        $sql .= " AND p.user_id = '" . (int)$data['filter_author_id'] . "'";
                    }
                    if (!empty($data['filter_category_id'])) {
                        $sql .= " AND p2c.category_id = '" . (int)$data['filter_category_id'] . "'";
                    }
                    $sql .= " GROUP BY p.post_id";

                    if (isset($data['sort'])) {
			$sql .= " ORDER BY " . $data['sort'];
                    } else {
                        $sql .= " ORDER BY p.date_published";
                    }

                    if (isset($data['order']) && ($data['order'] == 'ASC')) {
                        $sql .= " ASC";
                    } else {
                        $sql .= " DESC";
                    }
                    if (isset($data['start']) || isset($data['limit'])) {
                        if ($data['start'] < 0) {
                            $data['start'] = 0;
                        }
                        if ($data['limit'] < 1) {
                            $data['limit'] = 20;
                        }
                        $sql .= " LIMIT " . (int)$data['start'] . "," . (int)$data['limit'];
                    }
                    $query = $this->db->query($sql);
                    return $query->rows;
                }
                public function gettypePostID($postID)
                {
                    $sql = "SELECT p.type ";
                    $sql .= " FROM " . DB_PREFIX . "bm_post p WHERE post_id =".$postID;
                    $query = $this->db->query($sql);
                    return $query->row;
                }

                ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[public function getTotalPosts($data = array())]]></search>
            <add position="before"><![CDATA[
                public function getTypeTotalPosts($data = array())
                {
                    $sql = "SELECT COUNT(DISTINCT p.post_id) AS total ";
                    if (!empty($data['filter_category_id'])) {
                        $sql .= " FROM " . DB_PREFIX . "bm_post_to_category p2c";
                        $sql .= " LEFT JOIN " . DB_PREFIX . "bm_post p ON (p2c.post_id = p.post_id)";
                    } else {
                        $sql .= " FROM " . DB_PREFIX . "bm_post p ";
                    }
                    $sql .= " LEFT JOIN " . DB_PREFIX . "bm_post_description pd ON (p.post_id = pd.post_id) "
                        . "LEFT JOIN " . DB_PREFIX . "bm_post_to_store p2s ON (p.post_id = p2s.post_id) "
                        . "Left JOIN " . DB_PREFIX . "bm_review r ON (p.post_id = r.post_id) "
                        . "WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "' "
                        . "AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "' "
                        . "AND p.type = '" . (int)$data['filter_post_type'] . "' "
                        . "AND p.status = '1' ";
                    if (!empty($data['filter_name']) && !empty($data['filter_description'])) {
                        $sql .= " AND ( pd.title LIKE '%" . $data['filter_name'] . "%' OR pd.description LIKE '%" . $data['filter_description'] . "%' )";
                    } else {
                        if (!empty($data['filter_name'])) {
                            $sql .= " AND pd.title LIKE '%" . $data['filter_name'] . "%'";
                        }
                        if (!empty($data['filter_description'])) {
                            $sql .= " AND pd.description LIKE '%" . $data['filter_description'] . "%'";
                        }
                    }
                    if (!empty($data['filter_category_id'])) {
                        $sql .= " AND p2c.category_id = '" . (int)$data['filter_category_id'] . "'";
                    }
                    if (!empty($data['filter_author_id'])) {
                        $sql .= " AND p.user_id = '" . (int)$data['filter_author_id'] . "'";
                    }
                    if (!empty($data['filter_date_published'])) {
                        $date = preg_split("/-/", $data['filter_date_published']);
                        $sql .= "AND YEAR(p.date_published) = " . $date[1] . " AND MONTH(p.date_published) = " . $date[0];
                    }
                    if (!empty($data['filter_tag'])) {
                        $sql .= " AND pd.tag LIKE '%" . $data['filter_tag'] . "%'";
                    }
                    $query = $this->db->query($sql);
                    return $query->row['total'];
                }


                ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[. "WHERE p.post_id = '" . $post_id . "' "]]></search>
            <add position="after"><![CDATA[
                    . "AND p.status = '1' "
                                . "AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' ";
                            $sql .= "GROUP BY p.post_id ";
                            $query = $this->db->query($sql);
                            if (empty($query->row['post_id'])) {
                                return false;
                            }
                            if (empty($query->row['rating'])) {
                                $query->row['rating'] = 0;
                            }
                            return $query->row;
                        }
                        public function getPostByType($post_id, $PostType)
                        {
                            $sql = "SELECT p.post_id, p.user_id,p.limit_access_user,p.limit_users,p.limit_access_user_group,p.limit_user_groups,p.user_id, p.image,p.image_title,p.image_alt, p.images_review, pd.tag, pd.title, pd.meta_title, p.date_added, p.date_modified, p.date_published, p.review_display, p.viewed,   ";
                            if($PostType == 1){
                                $sql .= "p.serves, p.serving_size, p.prep_time, p.cook_time, p.total_time, ";
                            }
                            $sql .= "pd.meta_description, pd.meta_keyword, pd.description, "
                                . "pd.short_description, COUNT(DISTINCT r.review_id) as review, ROUND(AVG(r.rating)) as rating "
                                . "FROM " . DB_PREFIX . "bm_post AS p "
                                . "LEFT JOIN " . DB_PREFIX . "bm_post_description AS pd "
                                . "ON (p.post_id = pd.post_id) "
                                . "Left JOIN " . DB_PREFIX . "bm_review AS r ON (p.post_id = r.post_id) "
                                . "WHERE p.post_id = '" . $post_id . "' "
                                . "AND p.type = '".$PostType."' "
            ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/extension/d_blog_module/category.php">
        <operation error="skip">
            <search><![CDATA[if ($this->setting['category']['sub_category_display']) {]]></search>
            <add position="before"><![CDATA[
        $data['submit_recipe'] = $this->url->link('information/information', 'information_id=10', true);
        $main_categories = $this->model_extension_d_blog_module_category->getCategoryParents($category_id);
        $current_category_parents_count =  count($main_categories);
        $mn_Cat = '';
        $news_cat = '';
        $data['second_level_title'] = '';
        $data['second_level_id'] = '';
        $main_cat_index = 0;
        $meta_title = $category_info['meta_title'];
        foreach($main_categories as $m_Cat){
            if($m_Cat['category_id'] == 10 ){  //Check for Recipe Category
                $mn_Cat = $m_Cat['category_id'];
                $meta_title = "Recipes - Stoneledge Farm - Leeds, NY";
            }
            if($m_Cat['category_id'] == 11 ){  //Check for News Category
                $news_cat = $m_Cat['category_id'];
                $limit = 6;
                $meta_title = "News - Stoneledge Farm - Leeds, NY";
            }
            if($main_cat_index == 1) {
               $data['second_level_title'] = $m_Cat['title'];
               $data['second_level_id'] = $m_Cat['category_id'];
            }
           $main_cat_index++;
        }

        $sub_Cats = $this->model_extension_d_blog_module_category->getCategories($mn_Cat);
        $data['sub_Cat'] = array();
        if ($sub_Cats) {
            foreach ($sub_Cats as $sub_Cat) {
                $data['sub_Cat'][] = array(
                    'category_id' => $sub_Cat['category_id'],
                    'image' => $this->model_tool_image->resize($sub_Cat['image'], 50, 50),
                    'title' => $sub_Cat['title'],
                    'href'  => $this->url->link('extension/d_blog_module/post/type&type=recipes', 'category_id=' . $sub_Cat['category_id'], 'SSL')
                );
            }
        }

        //on recepie 3rd level categories we always have to show siblings
        if($data['second_level_id']) {
            $categories = $this->model_extension_d_blog_module_category->getCategories($data['second_level_id']);
        }

            ]]></add>
        </operation>

        <operation error="skip">
            <search><![CDATA[
                $this->document->setTitle($category_info['meta_title']);
            ]]></search>
            <add position="after"><![CDATA[
               $this->document->setTitle($meta_title);
            ]]></add>
        </operation>


        <operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->model_extension_d_opencart_patch_load->view('extension/d_blog_module/category', $data));]]></search>
            <add position="delete"><![CDATA[
                //logic to load post detail page:- change template layout based on post type or post parent category

                if($news_cat != '' && $mn_Cat == '') {//news
                    $news_categories = $this->model_extension_d_blog_module_category->getCategories(11);//show category dropdown on top
                    foreach($news_categories as $news_category) {
                        $data['news_categories'][] = array(
                            'category_id' => $news_category['category_id'],
                            'title' => $news_category['title'],
                            'href' => $this->url->link('extension/d_blog_module/category', 'category_id=' . $news_category['category_id'], 'SSL')
                        );
                    }
                
                    //set height of the post block based on the category selected
                    $height = '';
                    switch($category_id) {
                        case  '79'://featured
                            $height = '';
                        break;
                
                        case  '54'://farm news
                            $height = '664px';
                        break;
                
                        case  '53'://events
                            $height = '595px';
                        break;
                
                        case  '12'://crop harvest
                            $height = '565px';
                        break;    
                
                        default:
                            $height = '';
                        break;
                    }
                    
                    $data['height'] = $height;
                    $data['all_new_link'] = $this->url->link('extension/d_blog_module/post/type&type=news', '', 'SSL');
                    $this->response->setOutput($this->model_extension_d_opencart_patch_load->view('extension/d_blog_module/category_news', $data));
                } elseif($news_cat == '' && $mn_Cat != '') {//recepie
                    $this->response->setOutput($this->model_extension_d_opencart_patch_load->view('extension/d_blog_module/category', $data));
                } else {
                    $this->response->setOutput($this->model_extension_d_opencart_patch_load->view('extension/d_blog_module/category', $data));
                }
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[
                'thumb' => $thumb,
            ]]></search>
            <add position="after"><![CDATA[
               'category_id' => $category['category_id'],
            ]]></add>
        </operation>

    </file>

</modification>